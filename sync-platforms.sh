#!/bin/bash

# Script tá»± Ä‘á»™ng sync táº¥t cáº£ platforms vÃ o main docker-compose.yml
# Usage: ./sync-platforms.sh

MAIN_COMPOSE="docker-compose.yml"
BACKUP_COMPOSE="docker-compose.yml.backup"

echo "ðŸ”„ Syncing platforms to main docker-compose.yml..."

# Backup file gá»‘c
if [ -f "$MAIN_COMPOSE" ]; then
    cp "$MAIN_COMPOSE" "$BACKUP_COMPOSE"
    echo "ðŸ“‹ Backup created: $BACKUP_COMPOSE"
fi

# Táº¡o file docker-compose.yml má»›i
cat > "$MAIN_COMPOSE" << 'EOF'
# Docker Master Platform - Main Orchestration File
# Auto-generated by sync-platforms.sh

version: '3.8'

include:
EOF

# Tá»± Ä‘á»™ng tÃ¬m vÃ  thÃªm táº¥t cáº£ platforms
echo "ðŸ” Discovering platforms..."

for dir in platforms/*/; do
    if [ -d "$dir" ]; then
        platform_name=$(basename "$dir")
        
        # Bá» qua thÆ° má»¥c templates vÃ  base
        if [[ "$platform_name" != "templates" && "$platform_name" != "base" ]]; then
            # TÃ¬m file docker-compose trong thÆ° má»¥c
            for compose_file in "$dir"docker-compose.*.yml; do
                if [ -f "$compose_file" ]; then
                    relative_path="./platforms/$platform_name/$(basename "$compose_file")"
                    echo "  - $relative_path" >> "$MAIN_COMPOSE"
                    echo "  âœ… Added: $platform_name"
                    break
                fi
            done
        fi
    fi
done

# ThÃªm networks section náº¿u cáº§n
cat >> "$MAIN_COMPOSE" << 'EOF'

# Global networks
networks:
  app-network:
    name: docker_master_network
    external: true
EOF

echo ""
echo "âœ… Sync completed!"
echo "ðŸ“„ Main docker-compose.yml updated with all discovered platforms"
echo ""
echo "ðŸš€ You can now run: ./platform-manager.sh start"
